# Отчет о внедрении RAG (Retrieval-Augmented Generation)

Мы успешно внедрили систему RAG для Mishka AI. Это позволяет боту «запоминать» факты и использовать их в диалоге.

## 1. Архитектура
- **LLM Provider**: Новый эндпоинт `/v1/embeddings`, использующий модель Gemini `text-embedding-004`.
- **Memory Service**:
    - **Векторная БД**: Интегрирован Qdrant.
    - **Эндпоинты**: `/facts/add` (сохранение текста + эмбеддинга) и `/facts/search` (семантический поиск).
- **Brain Service**:
    - **Интеграция**: При каждом сообщении пользователя Brain запрашивает у Memory релевантные факты.
    - **Промпт**: Найденные факты автоматически добавляются в Системный Промпт.

## 2. Внесенные изменения

### mishka-llm-provider
- Добавлен `POST /v1/embeddings`.
- Настроен на использование `models/text-embedding-004`.

### mishka-memory
- Добавлена зависимость `qdrant-client`.
- Реализован класс `QdrantManager` для работы с векторами.
- Сервис `mishka-memory` открыт на порту `8003` для тестирования.
- Добавлены `POST /facts/add` и `POST /facts/search`.

### mishka-brain
- Добавлена функция `retrieve_facts` в `graph.py`.
- Изменен `agent_node`: теперь перед вызовом LLM происходит поиск контекста.

## 3. Верификация

### Скрипт проверки (`verify_rag.py`)
Был создан скрипт для независимого тестирования сервиса памяти:
```bash
python services/mishka-memory/verify_rag.py
```
**Результаты:**
- Успешное добавление факта: "Mishka loves honey" (Мишка любит мед)
- Успешный поиск факта по запросу "What does Mishka like?" (Что любит Мишка?)

### Интеграция с Brain
С помощью внутреннего скрипта `verify_brain_internal.py` подтверждено, что `mishka-brain` успешно запрашивает данные у `mishka-memory` внутри docker-сети.

### Инструмент "Запомни" (`tools/memory`)
- Реализован микросервис с эндпоинтом `/run`, вызывающим `mishka-memory`.
- Инструмент registered в БД `mishka-memory` как `remember_fact`.
- LLM теперь может вызывать этот инструмент для сохранения информации.

## 4. Использование
- **Автоматически**: Напишите "Запомни, меня зовут Влад". Бот вызовет `remember_fact`.
- **Проверка**: Спросите "Как меня зовут?". Бот найдет факт через RAG.
- **Ручное добавление**: `POST http://localhost:8003/facts/add` `{"text": "..."}`
