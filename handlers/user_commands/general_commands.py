# mishka_ai/handlers/user_commands/general_commands.py
import logging
from telegram import Update, constants
from telegram.ext import ContextTypes
from mishka_ai.handlers.common import _add_new_user_if_needed

logger = logging.getLogger(__name__)


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start."""
    user = update.effective_user
    current_users_data: dict = context.bot_data.get("users_data_dict", {})
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π, –±–æ–ª–µ–µ "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π" —Å—Ç–∞—Ä—Ç
    await update.message.reply_html(
        rf"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {user.mention_html()}. –Ø ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬´–ú–∏—à–∫–∞¬ª. –ú–æ–∏ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Ü–µ–ø–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã. –ì–æ—Ç–æ–≤ –∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –î–ª—è –≤—ã–∑–æ–≤–∞ —Å–ø—Ä–∞–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /help_ai",
    )
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} (ID: {user.id}) –≤—ã–ø–æ–ª–Ω–∏–ª –ø—Ä–æ—Ç–æ–∫–æ–ª /start.")
    
    target_chat_id = context.bot_data.get("target_chat_id")
    if target_chat_id is None or update.effective_chat.id == target_chat_id:
        if _add_new_user_if_needed(user, current_users_data, context):
            logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.full_name} (ID: {user.id}) –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ /start.")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    user_id_str = str(update.effective_user.id)
    admin_user_id = context.bot_data.get("admin_user_id")
    is_admin = admin_user_id and user_id_str == admin_user_id
    
    target_chat_id = context.bot_data.get("target_chat_id")
    is_bot_active = context.bot_data.get("is_bot_active", True)

    # --- –ù–û–í–´–ô –°–ï–†–¨–ï–ó–ù–´–ô –¢–ï–ö–°–¢ –î–õ–Ø HELP ---
    help_text = "ü§ñ *–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬´–ú–∏—à–∫–∞¬ª*\n"
    help_text += "_–°–∏—Å—Ç–µ–º–∞ —Å –≥–∏–±—Ä–∏–¥–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –Ω–∞ –±–∞–∑–µ LLM._\n\n"
    
    help_text += "*–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞–º—è—Ç–∏:*\n"
    help_text += "–Ø –∏—Å–ø–æ–ª—å–∑—É—é —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø–∞–º—è—Ç–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –≥–ª—É–±–æ–∫–æ–≥–æ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:\n"
    help_text += "1.  *–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (STM):* –û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.\n"
    help_text += "2.  *–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (LTM):* –í–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (ChromaDB) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤.\n"
    help_text += "3.  *–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å (EM):* –°–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –æ–±—â–µ–Ω–∏—è —Å –∫–∞–∂–¥—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º.\n\n"

    help_text += "*–û—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:*\n"
    help_text += "–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–æ–µ–≥–æ –∏–º–µ–Ω–∏ ('–º–∏—à', '–º–∏—à–∞', '–º–∏—à—É', '–º–∏—à–∫–∞', '–º–∏—à–∫—É', '–º–∏—à–∫–µ', '–º–∏—à–∞–Ω—è', '–º–∏—à–∞–Ω—å', '–º–∏—à—É–Ω—è', '–º–∏—à—É–Ω—å', '–º–∏—à–µ–Ω—å–∫–∞', '–º–∏—à—É—Ç–∫–∞', '–º–∏—Ö–∞', '–º–∏—Ö–∞–∏–ª', '–ø–æ—Ç–∞–ø—ã—á', '–º–µ–¥–≤–µ–¥—å', '–º–µ–¥–≤–µ–¥—é—à–∫–∞', '—Ç–æ–ø—Ç—ã–≥–∏–Ω', '–∫–æ—Å–æ–ª–∞–ø—ã–π') –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ LTM –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.\n\n"
    
    help_text += "*–û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
    help_text += "`/chatid` - –ü–æ–ª—É—á–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.\n"
    
    if is_admin:
        bot_status_emoji = "üü¢" if is_bot_active else "üî¥"
        bot_status_text = "–ê–ö–¢–ò–í–ï–ù" if is_bot_active else "–ü–†–ò–û–°–¢–ê–ù–û–í–õ–ï–ù (PAUSED)"
        help_text += f"\nüëë *–ü—Ä–æ—Ç–æ–∫–æ–ª—ã –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:*\n"
        help_text += f"   *–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:* {bot_status_emoji} *{bot_status_text}*\n"
        help_text += "   `/toggle_bot_active` - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n"
        
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:*\n"
        help_text += "  `/list_users` - –í—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å—É–±—ä–µ–∫—Ç–æ–≤.\n"
        help_text += "  `/show_user_info` `[ID|–∏–º—è|–Ω–∏–∫]` - –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å—É–±—ä–µ–∫—Ç—É.\n\n"
        
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ü–∞–º—è—Ç—å—é (LTM):*\n"
        help_text += "  `/memory_stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –ø–∞–º—è—Ç–∏.\n"
        help_text += "  `/list_facts` - –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ LTM.\n"
        help_text += "  `/find_facts` `[–∑–∞–ø—Ä–æ—Å]` - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ñ–∞–∫—Ç–æ–≤ –≤ LTM.\n"
        help_text += "  `/delete_fact` `[ID]` - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–∫—Ç –ø–æ –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É ID.\n"
        help_text += "  `/maintain_ltm` - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä—É—á–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ LTM (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö).\n"
        help_text += "  `/clear_ltm_admin_danger_zone` - *[DANGER]* –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ LTM.\n\n"
        
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ü–∞–º—è—Ç—å—é (EM):*\n"
        help_text += "  `/clear_emo_user` `[ID|–∏–º—è|–Ω–∏–∫]` - –û—á–∏—Å—Ç–∏—Ç—å EM –¥–ª—è —Å—É–±—ä–µ–∫—Ç–∞.\n"
        help_text += "  `/clear_emo_all_danger` - *[DANGER]* –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π EM.\n"

    help_text += "\n_v1.0. Mishka AI Core_"

    await update.message.reply_text(help_text, parse_mode=constants.ParseMode.MARKDOWN)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {update.effective_user.full_name} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∏—Å—Ç–µ–º–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (/help).")


async def chat_id_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞."""
    chat_id = update.effective_chat.id
    message_text = f"–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞ (Chat ID): `{chat_id}`"
    user_full_name = update.effective_user.full_name
    await update.message.reply_text(message_text, parse_mode=constants.ParseMode.MARKDOWN)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_full_name} (ID: {update.effective_user.id}) –∑–∞–ø—Ä–æ—Å–∏–ª Chat ID: {chat_id}")