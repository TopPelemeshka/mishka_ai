# mishka_ai/handlers/user_commands/general_commands.py
import logging
from telegram import Update, constants
from telegram.ext import ContextTypes
from mishka_ai.handlers.common import _add_new_user_if_needed 

logger = logging.getLogger(__name__)

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start."""
    user = update.effective_user
    current_users_data: dict = context.bot_data.get("users_data_dict", {})
    
    await update.message.reply_html(
        rf"–ü—Ä–∏–≤–µ—Ç, {user.mention_html()}! –Ø –ú–∏—à–∫–∞, —Ç–≤–æ–π –Ω–æ–≤—ã–π –¥—Ä—É–≥-–º–µ–¥–≤–µ–¥—å –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ. –ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é!",
    )
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.full_name} (ID: {user.id}) –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–∞–Ω–¥—É /start.")
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if target_chat_id is None or update.effective_chat.id == target_chat_id: # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ü–µ–ª–µ–≤–æ–º —á–∞—Ç–µ –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        if _add_new_user_if_needed(user, current_users_data, context): 
            logger.info(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.full_name} (ID: {user.id}) —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–æ—Å–ª–µ /start.")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    user_id_str = str(update.effective_user.id) 
    admin_user_id = context.bot_data.get("admin_user_id")
    is_admin = admin_user_id and user_id_str == admin_user_id 
    
    target_chat_id = context.bot_data.get("target_chat_id")
    is_bot_active = context.bot_data.get("is_bot_active", True)

    help_text = "üêª *–ü—Ä–∏–≤–µ—Ç, —è –ú–∏—à–∫–∞!* –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n\n"
    
    if target_chat_id and update.effective_chat.id != target_chat_id and not is_admin:
        help_text += f"–Ø —Ä–∞–±–æ—Ç–∞—é —Ç–æ–ª—å–∫–æ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º —á–∞—Ç–µ. –≠—Ç–æ—Ç —á–∞—Ç (`{update.effective_chat.id}`) –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–∏–º –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–±–æ—á–∏–º –º–µ—Å—Ç–æ–º.\n\n"
        help_text += "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help –≤ —Ü–µ–ª–µ–≤–æ–º —á–∞—Ç–µ."
        await update.message.reply_text(help_text, parse_mode=constants.ParseMode.MARKDOWN)
        return
    elif target_chat_id:
         help_text += f"‚ÑπÔ∏è –Ø –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤ —á–∞—Ç–µ —Å ID: `{target_chat_id}`.\n"


    help_text += "–ß—Ç–æ–±—ã –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞—á–∏–Ω–∞—è —Å –º–æ–µ–≥–æ –∏–º–µ–Ω–∏ (–ú–∏—à–∫–∞, –ú–∏—à, –ú–∏—à–∞–Ω—è –∏ —Ç.–¥.) –∏–ª–∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –æ–¥–Ω–æ –∏–∑ –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n" 
    help_text += "–Ø —Å—Ç–∞—Ä–∞—é—Å—å –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –Ω–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö, —á—Ç–æ–±—ã –±—ã—Ç—å –ª—É—á—à–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º.\n\n"
    help_text += "/chatid - –ü–æ–∫–∞–∑–∞—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.\n" 
    
    if is_admin:
        bot_status_emoji = "üü¢" if is_bot_active else "üî¥"
        bot_status_text = "–ê–∫—Ç–∏–≤–µ–Ω" if is_bot_active else "–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–∞ –ø–∞—É–∑–µ)"
        help_text += f"\nüëë *–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:*\n"
        help_text += f"   –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞: {bot_status_emoji} *{bot_status_text}*\n"
        help_text += "   /toggle\\_bot\\_active - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞ (–ø–∞—É–∑–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ).\n"
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã–º–∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:*\n"
        help_text += "  /list\\_users - –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n"
        help_text += "  /show\\_user\\_info `[ID | –∏–º—è | –Ω–∏–∫]` - –ò–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.\n"
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ü–∞–º—è—Ç—å—é (–§–∞–∫—Ç—ã LTM):*\n"
        help_text += "  /memory\\_stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏ (–≤–∫–ª—é—á–∞—è LTM –∏ –≠–º–æ—Ü. –ø–∞–º—è—Ç—å).\n"
        help_text += "  /list\\_facts - –°–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤ –∏–∑ LTM (ID —Ñ–∞–∫—Ç–∞ –≤–∏–¥–µ–Ω –∑–¥–µ—Å—å).\n"
        help_text += "  /find\\_facts `[–∫–ª—é—á. —Å–ª–æ–≤–∞]` - –ü–æ–∏—Å–∫ —Ñ–∞–∫—Ç–æ–≤ –≤ LTM.\n"
        help_text += "  /delete\\_fact `[ID —Ñ–∞–∫—Ç–∞]` - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–∫—Ç –∏–∑ LTM.\n"
        help_text += "  /maintain\\_ltm `[sim_thresh] [days_old] [min_acc]` - –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ LTM (—É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π/—Å—Ç–∞—Ä—ã—Ö). –ê—Ä–≥—É–º–µ–Ω—Ç—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã.\n"
        help_text += "     `sim_thresh`: –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0.0-1.0, —É–º–æ–ª—á. 0.9)\n"
        help_text += "     `days_old`: –º–∞–∫—Å. –¥–Ω–µ–π –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ (—É–º–æ–ª—á. 90)\n"
        help_text += "     `min_acc`: –º–∏–Ω. –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä. (—É–º–æ–ª—á. 1)\n"
        help_text += "  /clear\\_ltm\\_admin\\_danger\\_zone - *–û–ü–ê–°–ù–û!* –û—á–∏—Å—Ç–∏—Ç—å –í–°–ï —Ñ–∞–∫—Ç—ã LTM.\n"
        help_text += "*–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ü–∞–º—è—Ç—å—é:*\n"
        help_text += "  /clear\\_emo\\_user `[ID | –∏–º—è | –Ω–∏–∫]` - –û—á–∏—Å—Ç–∏—Ç—å —ç–º–æ—Ü. –ø–∞–º—è—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
        help_text += "  /clear\\_emo\\_all\\_danger - *–û–ü–ê–°–ù–û!* –û—á–∏—Å—Ç–∏—Ç—å –í–°–Æ —ç–º–æ—Ü. –ø–∞–º—è—Ç—å.\n"
        help_text += "   _(–î–ª—è –∫–æ–º–∞–Ω–¥ —Å ID/–∏–º–µ–Ω–µ–º/–Ω–∏–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏—Ö –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥—ã.)_\n"

    help_text += "\n–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –∏–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∏–¥–µ–∏, –∫–∞–∫ –º–µ–Ω—è —É–ª—É—á—à–∏—Ç—å, —Å–æ–æ–±—â–∏ –º–æ–µ–º—É —Å–æ–∑–¥–∞—Ç–µ–ª—é!"

    try:
        await update.message.reply_text(help_text, parse_mode=constants.ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ /help —Å–æ–æ–±—â–µ–Ω–∏—è (Markdown): {e}", exc_info=True)
        simplified_help_text = ("–ü—Ä–∏–≤–µ—Ç, —è –ú–∏—à–∫–∞! –û–±—Ä–∞—â–∞–π—Å—è –∫–æ –º–Ω–µ –ø–æ –∏–º–µ–Ω–∏. –ö–æ–º–∞–Ω–¥—ã: /chatid.\n"
                                "–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã: /toggle_bot_active, /memory_stats, /list_users, /show_user_info, "
                                "/list_facts, /find_facts, /delete_fact, /maintain_ltm, /clear_ltm_admin_danger_zone, "
                                "/clear_emo_user, /clear_emo_all_danger.")
        await update.message.reply_text(simplified_help_text)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {update.effective_user.full_name} –∑–∞–ø—Ä–æ—Å–∏–ª /help.")


async def chat_id_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞."""
    chat_id = update.effective_chat.id
    message_text = f"ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: `{chat_id}`"
    user_full_name = update.effective_user.full_name
    try:
        await update.message.reply_text(message_text, parse_mode=constants.ParseMode.MARKDOWN)
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_full_name} (ID: {update.effective_user.id}) –∑–∞–ø—Ä–æ—Å–∏–ª ID —á–∞—Ç–∞: {chat_id}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ID —á–∞—Ç–∞ –¥–ª—è {user_full_name}: {e}", exc_info=True)
        await update.message.reply_text(f"ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {chat_id}") 